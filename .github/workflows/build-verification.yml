name: PR Build

on: [ pull_request ]

jobs:
    init:
        name: Init
        runs-on: ubuntu-latest
        steps:
            -   name: Checkout
                uses: actions/checkout@v3
            -   name: Set up JDK 8
                uses: actions/setup-java@v3
                with:
                    java-version: '8'
                    distribution: 'temurin'
            -   name: Test failure
                run: |
                    for ((i=1; i <= 5; i++))
                    do
                     echo "BUILD SCAN PUBLICATION $i/$nbScans"
                     #(./gradlew buildScanPublishPrevious || true) | tee build.out
                     (mvn gradle-enterprise:build-scan-publish-previous || true) | tee build.out
                    done
                    echo "END"
            -   name: Build with Maven 1
                run: mvn clean
            -   name: Save Build Scan 1
                uses: jprinet/test-gradle/.github/actions/build-scan-save@v1
                with:
                    build-tool: "maven"
            -   name: Build with Maven 2
                run: mvn initialize
            -   name: Save Build Scan 2
                uses: jprinet/test-gradle/.github/actions/build-scan-save@v1
                with:
                    build-tool: "maven"

    build:
        name: Build
        needs: Init
        runs-on: ubuntu-latest
        steps:
            -   name: Checkout
                uses: actions/checkout@v3
            -   name: Set up JDK 8
                uses: actions/setup-java@v3
                with:
                    java-version: '8'
                    distribution: 'temurin'
            -   name: Set up Gradle
                uses: gradle/gradle-build-action@v2
            -   name: Build with Gradle 1
                run: ./gradlew help -Dscan.tag.build
            -   name: Save Build Scan 1
                uses: jprinet/test-gradle/.github/actions/build-scan-save@v1
            -   name: Build with Gradle 2
                run: ./gradlew tasks -Dscan.tag.build
            -   name: Save Build Scan 2
                uses: jprinet/test-gradle/.github/actions/build-scan-save@v1

    test-matrix:
        name: test-matrix
        strategy:
            matrix:
                version: [ 42, 142, 1042 ]
        needs: Build
        runs-on: ubuntu-latest
        steps:
            -   name: Checkout
                uses: actions/checkout@v3
            -   name: Set up JDK 8
                uses: actions/setup-java@v3
                with:
                    java-version: '8'
                    distribution: 'temurin'
            -   name: Set up Gradle
                uses: gradle/gradle-build-action@v2
            -   name: Build with Gradle 1
                run: ./gradlew help -Dscan.tag.test -Dscan.value.version=${{ matrix.version }}
            -   name: Save Build Scan 1
                uses: jprinet/test-gradle/.github/actions/build-scan-save@v1
            -   name: Build with Gradle 2
                run: ./gradlew tasks -Dscan.tag.test -Dscan.tag.version=${{ matrix.version }}
            -   name: Save Build Scan 2
                uses: jprinet/test-gradle/.github/actions/build-scan-save@v1
