name: "Gradle Enterprise Build Scan Upload"

on:
  workflow_call:
    inputs:
      tos-workflow-name:
        description: "Name of the Github Workflow checking TOS Approval"
        required: false
        default: "GE-TOS"
        type: string
      build-run-id:
        description: "Build Run ID"
        type: string
      build-sha:
        description: "Build SHA"
        type: string
      build-pr:
        description: "Build PR"
        type: string

jobs:
  build-scan-upload:
    runs-on: ubuntu-latest
    steps:
      - name: Download Build Metadata
        uses: dawidd6/action-download-artifact@v2
        with:
          run_id: ${{ inputs.build-run-id }}
      - name: Init environment
        # Required as $HOME is not expanded in a classical env section
        id: init-env
        run: |
          BUILD_TOOL_HOME=".m2/.gradle-enterprise"
          BUILD_METADATA_DIR="build-metadata-maven-*"
          BUILD_SCAN_DATA_DIR="$HOME/$BUILD_TOOL_HOME/build-scan-data"
          
          echo "BUILD_SCAN_DATA_DIR=$BUILD_SCAN_DATA_DIR" >> $GITHUB_ENV
          echo "BUILD_METADATA_DIR=$BUILD_METADATA_DIR" >> $GITHUB_ENV
          
          mkdir -p $BUILD_SCAN_DATA_DIR
      - name: Restore Build Metadata
        run: |
          # cp --backup=numbered allows to avoid error with duplicates "cp: will not overwrite just-created <filename> with <sameFilename>"
          cp -r --backup=numbered $BUILD_METADATA_DIR/* $BUILD_SCAN_DATA_DIR
#      - name: Wait for approval of Gradle Enterprise TOS
#        uses: actions/github-script@v6
#        id: check-tos
#        env:
#          sha: ${{ inputs.build-sha }}
#          pr: ${{ inputs.build-pr }}
#        with:
#          github-token: ${{ secrets.GITHUB_TOKEN }}
#          result-encoding: string
#          script: |
#            const delay = ms => new Promise(resolve => setTimeout(resolve, ms));
#
#            // Run several checks to allow delayed approval
#            for(let i = 1; i < 5; i++, await delay(15000)) {
#              console.log('Attempt ' + i);
#              // returns most recent check runs first by default
#              const checkRuns = await github.paginate('GET /repos/${{ github.repository }}/commits/{ref}/check-runs', {
#                ref: process.env.sha,
#                per_page: 50
#              });
#              for await (const cr of checkRuns) {
#                console.log('Found execution of ' + cr.name);
#                // check only last execution of the TOS workflow
#                if(cr.name == '${{ inputs.tos-workflow-name }}') {
#                  console.log('Found execution of ${{ inputs.tos-workflow-name }} at ' + cr.completed_at);
#                  if(cr.conclusion == 'success') {
#                    return;
#                  } else {
#                    throw new Error('Found failed execution of ${{ inputs.tos-workflow-name }} at ' + cr.completed_at);
#                  }
#                }
#              }
#            }
#            throw new Error('No execution found for ${{ inputs.tos-workflow-name }}');
      - name: Checkout
        uses: actions/checkout@v3
      - name: Set up JDK 8
        uses: actions/setup-java@v3
        with:
          java-version: '8'
          distribution: 'temurin'
      - name: Publish build scan
        id: publish
        run: |
          # Do not fail the step in case of error
          set +e
          
          scanlinks=""
          nbScans=$(find $BUILD_SCAN_DATA_DIR/*/previous/* -type d | wc -l)
          
          for ((i=1; i <= $nbScans; i++))
          do
            echo "BUILD SCAN PUBLICATION $i/$nbScans"
            mvn gradle-enterprise:build-scan-publish-previous | tee build.out
          
            scanLink=$(grep -A1 "Publishing build scan..." build.out  | tail -n 1  | sed 's/\[INFO\] //')
            if [[ ! -z "$scanLink" ]]
            then
              echo "Found scan link $scanLink"
              scanlinks="${scanlinks}<br>[Gradle Enterprise Build ScanÂ® $i]($scanLink)"
            fi
          done
          echo "scanlinks=$scanlinks" >> $GITHUB_OUTPUT
      - name: Comment PR
        uses: actions/github-script@v6
        env:
          pr: ${{ inputs.build-pr }}
          scanlinks: ${{ steps.publish.outputs.scanlinks }}
        with:
          script: |
            const prNumber = Number(process.env.pr);
            const message = process.env.scanlinks;
            
            if(message.length > 0) {
              github.rest.issues.createComment({
                issue_number: prNumber,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: message
              });
            }

